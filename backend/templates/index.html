<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phát hiện & Phân loại Chim</title> <!-- Cập nhật tiêu đề -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> <!-- Liên kết đến style.css -->
</head>
<body>
    <div class="container"> <!-- Thêm container để căn giữa và giới hạn chiều rộng -->
        <h1>Phát hiện & Phân loại Loài Chim</h1> <!-- Cập nhật tiêu đề -->

        <form action="{{ url_for('predict') }}" method="post" enctype="multipart/form-data" class="upload-form"> <!-- Thêm class -->
            <input type="file" name="image" accept="image/*" required>
            <button type="submit">Tải lên và Dự đoán</button> <!-- Cập nhật text -->
        </form>

        {% if error_message %}
            <p class="error-message">{{ error_message }}</p> <!-- Hiển thị thông báo lỗi -->
        {% endif %}

        {% if result_image %}
            <div class="result-container">
                <h2>Kết quả Phát hiện trên Ảnh:</h2>
                <img src="{{ result_image }}" alt="Kết quả Phát hiện và Phân loại">
            </div>

            {% if detection_results %}
                <div class="detection-details">
                    <h2>Chi tiết các Loài Chim được Phát hiện:</h2>
                    {% for detection in detection_results %}
                        <div class="bird-result">
                            <h3>Chim {{ loop.index }}</h3> <!-- Đánh số thứ tự chim -->
                            <p><strong>Phát hiện YOLO:</strong> {{ detection.yolo_class }} (Độ tin cậy: {{ detection.yolo_conf | round(2) }})</p>
                            {# Sửa lỗi cú pháp định dạng số thập phân #}
                            <p><strong>Phân loại Loài:</strong> {{ detection.species_name }} (Độ tin cậy: {% if detection.species_conf is not none %}{{ detection.species_conf | round(2) }}{% else %}N/A{% endif %})</p>

                            {% if detection.species_info and detection.species_info != "Không thể lấy thông tin chi tiết." %}
                                <div class="species-info">
                                    <h4>Thông tin về Loài {{ detection.species_name }}:</h4>
                                    <p>{{ detection.species_info }}</p>
                                </div>
                            {% elif detection.species_info %}
                                <p class="info-unavailable">{{ detection.species_info }}</p> <!-- Hiển thị thông báo lỗi/không có info -->
                            {% endif %}


                            {% if detection.image_urls %}
                                <div class="image-gallery">
                                    <h4>Hình ảnh của Loài {{ detection.species_name }}:</h4>
                                    <div class="gallery-grid">
                                        {% for image_url in detection.image_urls %}
                                            <img src="{{ image_url }}" alt="Hình ảnh của {{ detection.species_name }}">
                                        {% endfor %}
                                    </div>
                                </div>
                            {% elif detection.species_name and detection.species_name != "N/A" and not detection.species_name.startswith("Error") and not detection.species_name.startswith("Invalid") %}
                                <p class="info-unavailable">Không tìm thấy hình ảnh nào cho loài chim {{ detection.species_name }}.</p>
                            {% endif %}
                            {% if detection.audio_urls %}
                                <div class="audio-gallery">
                                    <h4>Tiếng hót của Loài {{ detection.species_name }}:</h4>
                                    <div class="audio-list">
                                        {% for audio_url in detection.audio_urls %}
                                            <p>Bản ghi {{ loop.index }}: <audio controls src="{{ audio_url }}">
                                                Trình duyệt của bạn không hỗ trợ phần tử audio.
                                                <a href="{{ audio_url }}">Tải về bản ghi âm</a>.
                                            </audio></p>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% elif detection.species_name and detection.species_name != "N/A" and not detection.species_name.startswith("Error") and not detection.species_name.startswith("Invalid") %}
                                <p class="info-unavailable">Không tìm thấy bản ghi âm tiếng hót nào trên Xeno-Canto cho loài chim {{ detection.species_name }}.</p>
                            {% endif %}

                        </div>
                    {% endfor %}
                </div>
            {% endif %}

        {% endif %}

    </div> <!-- Kết thúc container -->

</body>
</html>